# 01 - ç¯å¢ƒæ­å»ºæŒ‡å—

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£… Android Studio

ä¸‹è½½åœ°å€ï¼šhttps://developer.android.com/studio

**æ¨èç‰ˆæœ¬**: Android Studio Hedgehog (2023.1.1) æˆ–æ›´æ–°ç‰ˆæœ¬

å®‰è£…ç»„ä»¶é€‰æ‹©ï¼š
- [x] Android SDK Platform 34
- [x] Android SDK Build-Tools 34
- [x] Android Emulator (å¯é€‰ï¼Œä½†æ¨èç”¨äºåŸºç¡€UIæµ‹è¯•)
- [x] Android SDK Platform-Tools
- [x] NDK (Side by side) 25.2.x
- [x] CMake 3.22.1

### 2. é…ç½® NDK

MNN éœ€è¦ NDK è¿›è¡ŒåŸç”Ÿä»£ç ç¼–è¯‘ï¼š

```
Android Studio â†’ Settings â†’ Appearance & Behavior â†’ System Settings â†’ Android SDK
â†’ SDK Tools æ ‡ç­¾é¡µ â†’ å‹¾é€‰ "NDK (Side by side)" â†’ Apply
```

éªŒè¯ NDK è·¯å¾„ï¼š
```bash
# åœ¨ Android Studio Terminal ä¸­è¿è¡Œ
$ ndk-build --version
GNU Make 4.3
Built for Windows32
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

Windows ç³»ç»Ÿæ·»åŠ ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

```powershell
# ä½¿ç”¨ PowerShell ç®¡ç†å‘˜æƒé™
[Environment]::SetEnvironmentVariable("ANDROID_SDK_ROOT", "C:\Users\<ç”¨æˆ·å>\AppData\Local\Android\Sdk", "User")
[Environment]::SetEnvironmentVariable("ANDROID_NDK", "C:\Users\<ç”¨æˆ·å>\AppData\Local\Android\Sdk\ndk\25.2.9519653", "User")
```

### 4. è·å– MNN æ¡†æ¶

#### æ–¹å¼ä¸€ï¼šç›´æ¥ä¸‹è½½é¢„ç¼–è¯‘åº“ï¼ˆæ¨èï¼‰

ä» MNN Release é¡µé¢ä¸‹è½½ Android é¢„ç¼–è¯‘åº“ï¼š

```bash
# ä¸‹è½½åœ°å€
https://github.com/alibaba/MNN/releases

# ä¸‹è½½æ–‡ä»¶ï¼šMNN-Android-GPU-Vulkan.zip æˆ– MNN-Android.zip

# è§£å‹åå°†ä»¥ä¸‹æ–‡ä»¶æ”¾å…¥é¡¹ç›®
MNN/libs/arm64-v8a/libMNN.so
MNN/includes/MNN/
```

#### æ–¹å¼äºŒï¼šæºç ç¼–è¯‘ï¼ˆé«˜çº§ç”¨æˆ·ï¼‰

```bash
# å…‹éš† MNN ä»“åº“
git clone https://github.com/alibaba/MNN.git
cd MNN

# æ›´æ–°å­æ¨¡å—
git submodule update --init

# åˆ›å»ºæ„å»ºç›®å½•
mkdir build_android && cd build_android

# é…ç½® CMake
set ANDROID_NDK=C:\Users\<ç”¨æˆ·å>\AppData\Local\Android\Sdk\ndk\25.2.9519653

cmake .. \
  -DCMAKE_TOOLCHAIN_FILE=%ANDROID_NDK%/build/cmake/android.toolchain.cmake \
  -DANDROID_ABI="arm64-v8a" \
  -DANDROID_PLATFORM=android-28 \
  -DMNN_BUILD_SHARED_LIBS=ON \
  -DMNN_VULKAN=ON \
  -DMNN_OPENCL=ON \
  -DCMAKE_BUILD_TYPE=Release

# ç¼–è¯‘
cmake --build . --config Release -j4
```

### 5. é¡¹ç›® Gradle é…ç½®

#### é¡¹ç›®çº§ build.gradle

```gradle
// build.gradle (Project: FoodDecisionAssistant)
buildscript {
    dependencies {
        classpath 'com.android.tools.build:gradle:8.2.0'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.20"
    }
}
```

#### åº”ç”¨çº§ build.gradle

```gradle
// app/build.gradle.kts
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("kotlin-kapt")
}

android {
    namespace = "com.foodassistant"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.foodassistant"
        minSdk = 28
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        ndk {
            abiFilters += listOf("arm64-v8a")
        }

        externalNativeBuild {
            cmake {
                cppFlags += "-std=c++14"
            }
        }
    }

    buildTypes {
        release {
            isMinifyEnabled = true
            proguardFiles(
                getDefaultProguardFile("proguard-android-optimize.txt"),
                "proguard-rules.pro"
            )
        }
    }
    
    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = "17"
    }

    externalNativeBuild {
        cmake {
            path = file("src/main/cpp/CMakeLists.txt")
            version = "3.22.1"
        }
    }
}

dependencies {
    // AndroidX
    implementation("androidx.core:core-ktx:1.12.0")
    implementation("androidx.appcompat:appcompat:1.6.1")
    implementation("com.google.android.material:material:1.11.0")
    implementation("androidx.constraintlayout:constraintlayout:2.1.4")
    
    // Architecture Components
    implementation("androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0")
    implementation("androidx.lifecycle:lifecycle-livedata-ktx:2.7.0")
    implementation("androidx.activity:activity-ktx:1.8.2")
    
    // Room (æ•°æ®åº“)
    implementation("androidx.room:room-runtime:2.6.1")
    implementation("androidx.room:room-ktx:2.6.1")
    kapt("androidx.room:room-compiler:2.6.1")
    
    // CameraX (æ‹ç…§)
    implementation("androidx.camera:camera-core:1.3.1")
    implementation("androidx.camera:camera-camera2:1.3.1")
    implementation("androidx.camera:camera-lifecycle:1.3.1")
    implementation("androidx.camera:camera-view:1.3.1")
    
    // Coil (å›¾ç‰‡åŠ è½½)
    implementation("io.coil-kt:coil-compose:2.5.0")
    
    // Coroutines
    implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3")
    
    // MNN (æœ¬åœ°ä¾èµ–)
    implementation(fileTree(mapOf("dir" to "libs", "include" to listOf("*.jar", "*.aar"))))
    
    // JSON è§£æ
    implementation("com.google.code.gson:gson:2.10.1")
}
```

### 6. é…ç½® CMake

åˆ›å»º `app/src/main/cpp/CMakeLists.txt`ï¼š

```cmake
cmake_minimum_required(VERSION 3.22.1)
project("foodassistant")

# è®¾ç½® MNN è·¯å¾„
set(MNN_ROOT ${CMAKE_SOURCE_DIR}/../../../libs/mnn)

# æ·»åŠ  MNN åº“
add_library(mnn SHARED IMPORTED)
set_target_properties(mnn PROPERTIES
    IMPORTED_LOCATION ${MNN_ROOT}/libs/${ANDROID_ABI}/libMNN.so
)

# å¤´æ–‡ä»¶è·¯å¾„
include_directories(${MNN_ROOT}/include)

# åˆ›å»ºæœ¬åœ°åº“
add_library(
    native-lib
    SHARED
    native-lib.cpp
)

# é“¾æ¥åº“
target_link_libraries(
    native-lib
    mnn
    log
    android
)
```

### 7. é¡¹ç›®ç›®å½•ç»“æ„åˆå§‹åŒ–

```bash
# åˆ›å»ºå¿…è¦çš„ç›®å½•
app/src/main/
â”œâ”€â”€ AndroidManifest.xml
â”œâ”€â”€ assets/
â”‚   â””â”€â”€ models/          # å­˜æ”¾ .mnn æ¨¡å‹æ–‡ä»¶
â”œâ”€â”€ cpp/
â”‚   â”œâ”€â”€ CMakeLists.txt
â”‚   â””â”€â”€ native-lib.cpp   # JNI æ¡¥æ¥ä»£ç 
â”œâ”€â”€ java/com/foodassistant/
â”‚   â”œâ”€â”€ MainActivity.kt
â”‚   â”œâ”€â”€ FoodApplication.kt
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â”œâ”€â”€ AppDatabase.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ PreferenceDao.kt
â”‚   â”‚   â”‚   â””â”€â”€ UserPreference.kt
â”‚   â”‚   â””â”€â”€ model/
â”‚   â”‚       â”œâ”€â”€ FoodImage.kt
â”‚   â”‚       â””â”€â”€ Recommendation.kt
â”‚   â”œâ”€â”€ mnn/
â”‚   â”‚   â”œâ”€â”€ MNNInference.kt
â”‚   â”‚   â”œâ”€â”€ Qwen2VLModel.kt
â”‚   â”‚   â””â”€â”€ ImagePreprocessor.kt
â”‚   â”œâ”€â”€ prompt/
â”‚   â”‚   â””â”€â”€ PromptBuilder.kt
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ MainViewModel.kt
â”‚       â”œâ”€â”€ components/
â”‚       â””â”€â”€ screens/
â””â”€â”€ res/
    â”œâ”€â”€ layout/
    â”œâ”€â”€ values/
    â””â”€â”€ xml/
```

### 8. éªŒè¯ç¯å¢ƒ

åˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ `app/src/main/cpp/native-lib.cpp`ï¼š

```cpp
#include <jni.h>
#include <string>
#include <MNN/Interpreter.hpp>

extern "C" JNIEXPORT jstring JNICALL
Java_com_foodassistant_mnn_MNNInference_stringFromJNI(JNIEnv* env, jobject /* this */) {
    std::string hello = "MNN Version: " + std::to_string(MNN::Interpreter::getVersion());
    return env->NewStringUTF(hello.c_str());
}
```

åŒæ­¥é¡¹ç›®å¹¶æ„å»ºï¼Œå¦‚æœæ²¡æœ‰æŠ¥é”™è¯´æ˜ç¯å¢ƒé…ç½®æˆåŠŸã€‚

## ğŸ”§ å¸¸è§é—®é¢˜

### Q: NDK not configured
**è§£å†³**: File â†’ Project Structure â†’ SDK Location â†’ è®¾ç½® Android NDK location

### Q: CMake ç‰ˆæœ¬ä¸åŒ¹é…
**è§£å†³**: Tools â†’ SDK Manager â†’ SDK Tools â†’ å®‰è£… CMake 3.22.1

### Q: libMNN.so not found
**è§£å†³**: ç¡®ä¿ `abiFilters` å’Œå®é™…soæ–‡ä»¶æ¶æ„ä¸€è‡´ï¼ˆæ¨è arm64-v8aï¼‰

### Q: ç¼–è¯‘å†…å­˜ä¸è¶³
**è§£å†³**: gradle.properties ä¸­æ·»åŠ  `org.gradle.jvmargs=-Xmx4g`

## ğŸ“± ä¸‹ä¸€æ­¥

ç¯å¢ƒæ­å»ºå®Œæˆåï¼Œè¿›å…¥ [02-æ¨¡å‹å‡†å¤‡.md](02-æ¨¡å‹å‡†å¤‡.md) ä¸‹è½½å’Œå‡†å¤‡ AI æ¨¡å‹ã€‚
